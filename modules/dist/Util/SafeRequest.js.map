{"version":3,"file":"SafeRequest.js","names":["_ZodValidation","require","_axios","safeRequest","cb","showError","req","res","next","response","closed","writable","send","e","console","warn","isAxiosError","dir","data","depth","Infinity","method","toUpperCase","originalUrl","isDefaultError","code","error","errorType","JSON","stringify","undefined","status","formattedError","fields","reduce","acc","curr","path","join","message","context","clear","exports"],"sources":["../../src/Util/SafeRequest.ts"],"sourcesContent":["import { type RequestHandler } from \"express\";\nimport { isDefaultError } from \"./ZodValidation\";\nimport { isAxiosError } from \"axios\";\n/**\n * This function will make it so whenever something throws inside a request handler\n * the API will function accordingly\n * @param cb\n * @param showError\n * @returns\n */\nexport const safeRequest =\n  (cb: RequestHandler, showError = false): RequestHandler =>\n  async (req, res, next) => {\n    try {\n      const response = await cb(req, res, next);\n      if (!res.closed || !res.writable) {\n        res.send(response);\n      }\n    } catch (e: any) {\n      console.warn(e);\n\n      if (showError) {\n        if (isAxiosError(e)) {\n          console.dir(e.response?.data, { depth: Infinity });\n        }\n\n        console.dir(\n          `[${req.method.toUpperCase()}] ${req.originalUrl} ${\n            isDefaultError(e) ? e.code : \"500\"\n          } - ${\n            isDefaultError(e)\n              ? `Reason: ${e.error?.errorType}, ${JSON.stringify(\n                  e,\n                  undefined,\n                  \"\"\n                )}`\n              : `Unexpected reason - ${JSON.stringify(e, undefined, \"  \")}`\n          }`,\n          { depth: Infinity }\n        );\n      }\n\n      if (isDefaultError(e)) {\n        if (e.error.errorType !== \"Validation\") {\n          if (!res.closed) {\n            res.status(e.code).send(e.error);\n          }\n        } else {\n          const formattedError = e.error.fields.reduce(\n            (acc, curr) => [\n              ...acc,\n              {\n                path:\n                  typeof curr.path === \"string\"\n                    ? curr.path\n                    : curr.path.join(\"/\"),\n                message: curr.message,\n              },\n            ],\n            [] as { path: string; message: string }[]\n          );\n\n          if (res.writable) {\n            res\n              .status(e.code)\n              .send({ errorType: \"Validation\", fields: formattedError });\n          }\n        }\n      }\n      req.context?.clear();\n    }\n  };\n"],"mappings":";;;;;;AACA,IAAAA,cAAA,GAAAC,OAAA;AACA,IAAAC,MAAA,GAAAD,OAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,MAAME,WAAW,GACtBA,CAACC,EAAkB,EAAEC,SAAS,GAAG,KAAK,KACtC,OAAOC,GAAG,EAAEC,GAAG,EAAEC,IAAI,KAAK;EACxB,IAAI;IACF,MAAMC,QAAQ,GAAG,MAAML,EAAE,CAACE,GAAG,EAAEC,GAAG,EAAEC,IAAI,CAAC;IACzC,IAAI,CAACD,GAAG,CAACG,MAAM,IAAI,CAACH,GAAG,CAACI,QAAQ,EAAE;MAChCJ,GAAG,CAACK,IAAI,CAACH,QAAQ,CAAC;IACpB;EACF,CAAC,CAAC,OAAOI,CAAM,EAAE;IACfC,OAAO,CAACC,IAAI,CAACF,CAAC,CAAC;IAEf,IAAIR,SAAS,EAAE;MACb,IAAI,IAAAW,mBAAY,EAACH,CAAC,CAAC,EAAE;QACnBC,OAAO,CAACG,GAAG,CAACJ,CAAC,CAACJ,QAAQ,EAAES,IAAI,EAAE;UAAEC,KAAK,EAAEC;QAAS,CAAC,CAAC;MACpD;MAEAN,OAAO,CAACG,GAAG,CACT,IAAIX,GAAG,CAACe,MAAM,CAACC,WAAW,CAAC,CAAC,KAAKhB,GAAG,CAACiB,WAAW,IAC9C,IAAAC,6BAAc,EAACX,CAAC,CAAC,GAAGA,CAAC,CAACY,IAAI,GAAG,KAAK,MAElC,IAAAD,6BAAc,EAACX,CAAC,CAAC,GACb,WAAWA,CAAC,CAACa,KAAK,EAAEC,SAAS,KAAKC,IAAI,CAACC,SAAS,CAC9ChB,CAAC,EACDiB,SAAS,EACT,EACF,CAAC,EAAE,GACH,uBAAuBF,IAAI,CAACC,SAAS,CAAChB,CAAC,EAAEiB,SAAS,EAAE,IAAI,CAAC,EAAE,EAC/D,EACF;QAAEX,KAAK,EAAEC;MAAS,CACpB,CAAC;IACH;IAEA,IAAI,IAAAI,6BAAc,EAACX,CAAC,CAAC,EAAE;MACrB,IAAIA,CAAC,CAACa,KAAK,CAACC,SAAS,KAAK,YAAY,EAAE;QACtC,IAAI,CAACpB,GAAG,CAACG,MAAM,EAAE;UACfH,GAAG,CAACwB,MAAM,CAAClB,CAAC,CAACY,IAAI,CAAC,CAACb,IAAI,CAACC,CAAC,CAACa,KAAK,CAAC;QAClC;MACF,CAAC,MAAM;QACL,MAAMM,cAAc,GAAGnB,CAAC,CAACa,KAAK,CAACO,MAAM,CAACC,MAAM,CAC1C,CAACC,GAAG,EAAEC,IAAI,KAAK,CACb,GAAGD,GAAG,EACN;UACEE,IAAI,EACF,OAAOD,IAAI,CAACC,IAAI,KAAK,QAAQ,GACzBD,IAAI,CAACC,IAAI,GACTD,IAAI,CAACC,IAAI,CAACC,IAAI,CAAC,GAAG,CAAC;UACzBC,OAAO,EAAEH,IAAI,CAACG;QAChB,CAAC,CACF,EACD,EACF,CAAC;QAED,IAAIhC,GAAG,CAACI,QAAQ,EAAE;UAChBJ,GAAG,CACAwB,MAAM,CAAClB,CAAC,CAACY,IAAI,CAAC,CACdb,IAAI,CAAC;YAAEe,SAAS,EAAE,YAAY;YAAEM,MAAM,EAAED;UAAe,CAAC,CAAC;QAC9D;MACF;IACF;IACA1B,GAAG,CAACkC,OAAO,EAAEC,KAAK,CAAC,CAAC;EACtB;AACF,CAAC;AAACC,OAAA,CAAAvC,WAAA,GAAAA,WAAA","ignoreList":[]}