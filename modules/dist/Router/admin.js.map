{"version":3,"file":"admin.js","names":["_express","require","_SafeRequest","V","_interopRequireWildcard","_adminsController","_interopRequireDefault","_JWT","_cookieParser","_SafeDatabaseTransaction","_sanitizeCity","_userController","_confirmationMessage","e","__esModule","default","t","WeakMap","r","n","o","i","f","__proto__","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","adminRouter","Router","post","useJWT","safeRequest","req","res","name","password","permissions","username","validate","string","array","body","result","adminsController","createAdmin","safeReturnTransaction","json","cookieParser","loginTransaction","login","isTransactionSuccessful","data","jwt","generateJwt","userId","id","cookie","httpOnly","expires","Date","now","sameSite","secure","suggestions","dryRunNormalizeCities","Promise","all","map","suggestion","userController","updateUser","city","after","send","eventId","sendConfirmationMessageToEveryone","success","_default","exports"],"sources":["../../src/Router/admin.ts"],"sourcesContent":["import { Router, json } from \"express\";\nimport { safeRequest } from \"../Util/SafeRequest\";\nimport * as V from \"../Util/ZodValidation\";\nimport adminsController from \"../database/controllers/adminsController\";\nimport { generateJwt, useJWT } from \"../JWT\";\nimport { useRequestContext } from \"../Util/requestContext\";\nimport cookieParser from \"cookie-parser\";\nimport {\n  isTransactionSuccessful,\n  safeReturnTransaction,\n} from \"../Util/SafeDatabaseTransaction\";\nimport { dryRunNormalizeCities } from \"../Util/sanitizeCity\";\nimport userController from \"../database/controllers/userController\";\nimport { sendConfirmationMessageToEveryone } from \"../Kozz-Module/Methods/confirmationMessage\";\n\nconst adminRouter = Router();\n\nadminRouter.post(\n  \"/create\",\n  useJWT([\"create-account\"]),\n  safeRequest(async (req, res) => {\n    const { name, password, permissions, username } = V.validate(\n      {\n        username: V.string,\n        password: V.string,\n        permissions: V.array(V.string),\n        name: V.string,\n      },\n      req.body\n    );\n\n    const result = await adminsController.createAdmin({\n      name,\n      password,\n      permissions,\n      username,\n    });\n\n    return safeReturnTransaction(result);\n  })\n);\n\nadminRouter.post(\n  \"/login\",\n  json(),\n  cookieParser(),\n  safeRequest(async (req, res) => {\n    const { username, password } = V.validate(\n      {\n        username: V.string,\n        password: V.string,\n      },\n      req.body\n    );\n\n    const loginTransaction = await adminsController.login(username, password);\n\n    if (!isTransactionSuccessful(loginTransaction)) {\n      return safeReturnTransaction(loginTransaction);\n    }\n\n    const result = loginTransaction.data;\n\n    const jwt = generateJwt({\n      userId: result.id,\n      username: result.name,\n    });\n\n    res.cookie(\"jwt\", jwt, {\n      httpOnly: true,\n\n      expires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),\n      sameSite: \"none\",\n      secure: true,\n    });\n\n    return { jwt };\n  })\n);\n\nadminRouter.post(\"/sanitize-city\", async (req, res) => {\n  const suggestions = await dryRunNormalizeCities();\n\n  const result = await Promise.all(\n    suggestions.map((suggestion) => {\n      userController.updateUser(suggestion.id, {\n        city: suggestion.after,\n      });\n    })\n  );\n\n  res.send(result);\n});\n\nadminRouter.post(\n  \"/send_confirmation_message_to_everyone\",\n  useJWT([\"admin\"]),\n  json(),\n  safeRequest(async (req) => {\n    const { eventId } = V.validate({ eventId: V.string }, req.body);\n\n    await sendConfirmationMessageToEveryone(eventId);\n\n    return {\n      success: true,\n    };\n  })\n);\n\nexport default adminRouter;\n"],"mappings":";;;;;;AAAA,IAAAA,QAAA,GAAAC,OAAA;AACA,IAAAC,YAAA,GAAAD,OAAA;AACA,IAAAE,CAAA,GAAAC,uBAAA,CAAAH,OAAA;AACA,IAAAI,iBAAA,GAAAC,sBAAA,CAAAL,OAAA;AACA,IAAAM,IAAA,GAAAN,OAAA;AAEA,IAAAO,aAAA,GAAAF,sBAAA,CAAAL,OAAA;AACA,IAAAQ,wBAAA,GAAAR,OAAA;AAIA,IAAAS,aAAA,GAAAT,OAAA;AACA,IAAAU,eAAA,GAAAL,sBAAA,CAAAL,OAAA;AACA,IAAAW,oBAAA,GAAAX,OAAA;AAA+F,SAAAK,uBAAAO,CAAA,WAAAA,CAAA,IAAAA,CAAA,CAAAC,UAAA,GAAAD,CAAA,KAAAE,OAAA,EAAAF,CAAA;AAAA,SAAAT,wBAAAS,CAAA,EAAAG,CAAA,6BAAAC,OAAA,MAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAb,uBAAA,YAAAA,CAAAS,CAAA,EAAAG,CAAA,SAAAA,CAAA,IAAAH,CAAA,IAAAA,CAAA,CAAAC,UAAA,SAAAD,CAAA,MAAAO,CAAA,EAAAC,CAAA,EAAAC,CAAA,KAAAC,SAAA,QAAAR,OAAA,EAAAF,CAAA,iBAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,SAAAS,CAAA,MAAAF,CAAA,GAAAJ,CAAA,GAAAG,CAAA,GAAAD,CAAA,QAAAE,CAAA,CAAAI,GAAA,CAAAX,CAAA,UAAAO,CAAA,CAAAK,GAAA,CAAAZ,CAAA,GAAAO,CAAA,CAAAM,GAAA,CAAAb,CAAA,EAAAS,CAAA,gBAAAN,CAAA,IAAAH,CAAA,gBAAAG,CAAA,OAAAW,cAAA,CAAAC,IAAA,CAAAf,CAAA,EAAAG,CAAA,OAAAK,CAAA,IAAAD,CAAA,GAAAS,MAAA,CAAAC,cAAA,KAAAD,MAAA,CAAAE,wBAAA,CAAAlB,CAAA,EAAAG,CAAA,OAAAK,CAAA,CAAAI,GAAA,IAAAJ,CAAA,CAAAK,GAAA,IAAAN,CAAA,CAAAE,CAAA,EAAAN,CAAA,EAAAK,CAAA,IAAAC,CAAA,CAAAN,CAAA,IAAAH,CAAA,CAAAG,CAAA,WAAAM,CAAA,KAAAT,CAAA,EAAAG,CAAA;AAE/F,MAAMgB,WAAW,GAAG,IAAAC,eAAM,EAAC,CAAC;AAE5BD,WAAW,CAACE,IAAI,CACd,SAAS,EACT,IAAAC,WAAM,EAAC,CAAC,gBAAgB,CAAC,CAAC,EAC1B,IAAAC,wBAAW,EAAC,OAAOC,GAAG,EAAEC,GAAG,KAAK;EAC9B,MAAM;IAAEC,IAAI;IAAEC,QAAQ;IAAEC,WAAW;IAAEC;EAAS,CAAC,GAAGvC,CAAC,CAACwC,QAAQ,CAC1D;IACED,QAAQ,EAAEvC,CAAC,CAACyC,MAAM;IAClBJ,QAAQ,EAAErC,CAAC,CAACyC,MAAM;IAClBH,WAAW,EAAEtC,CAAC,CAAC0C,KAAK,CAAC1C,CAAC,CAACyC,MAAM,CAAC;IAC9BL,IAAI,EAAEpC,CAAC,CAACyC;EACV,CAAC,EACDP,GAAG,CAACS,IACN,CAAC;EAED,MAAMC,MAAM,GAAG,MAAMC,yBAAgB,CAACC,WAAW,CAAC;IAChDV,IAAI;IACJC,QAAQ;IACRC,WAAW;IACXC;EACF,CAAC,CAAC;EAEF,OAAO,IAAAQ,8CAAqB,EAACH,MAAM,CAAC;AACtC,CAAC,CACH,CAAC;AAEDf,WAAW,CAACE,IAAI,CACd,QAAQ,EACR,IAAAiB,aAAI,EAAC,CAAC,EACN,IAAAC,qBAAY,EAAC,CAAC,EACd,IAAAhB,wBAAW,EAAC,OAAOC,GAAG,EAAEC,GAAG,KAAK;EAC9B,MAAM;IAAEI,QAAQ;IAAEF;EAAS,CAAC,GAAGrC,CAAC,CAACwC,QAAQ,CACvC;IACED,QAAQ,EAAEvC,CAAC,CAACyC,MAAM;IAClBJ,QAAQ,EAAErC,CAAC,CAACyC;EACd,CAAC,EACDP,GAAG,CAACS,IACN,CAAC;EAED,MAAMO,gBAAgB,GAAG,MAAML,yBAAgB,CAACM,KAAK,CAACZ,QAAQ,EAAEF,QAAQ,CAAC;EAEzE,IAAI,CAAC,IAAAe,gDAAuB,EAACF,gBAAgB,CAAC,EAAE;IAC9C,OAAO,IAAAH,8CAAqB,EAACG,gBAAgB,CAAC;EAChD;EAEA,MAAMN,MAAM,GAAGM,gBAAgB,CAACG,IAAI;EAEpC,MAAMC,GAAG,GAAG,IAAAC,gBAAW,EAAC;IACtBC,MAAM,EAAEZ,MAAM,CAACa,EAAE;IACjBlB,QAAQ,EAAEK,MAAM,CAACR;EACnB,CAAC,CAAC;EAEFD,GAAG,CAACuB,MAAM,CAAC,KAAK,EAAEJ,GAAG,EAAE;IACrBK,QAAQ,EAAE,IAAI;IAEdC,OAAO,EAAE,IAAIC,IAAI,CAACA,IAAI,CAACC,GAAG,CAAC,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;IACxDC,QAAQ,EAAE,MAAM;IAChBC,MAAM,EAAE;EACV,CAAC,CAAC;EAEF,OAAO;IAAEV;EAAI,CAAC;AAChB,CAAC,CACH,CAAC;AAEDzB,WAAW,CAACE,IAAI,CAAC,gBAAgB,EAAE,OAAOG,GAAG,EAAEC,GAAG,KAAK;EACrD,MAAM8B,WAAW,GAAG,MAAM,IAAAC,mCAAqB,EAAC,CAAC;EAEjD,MAAMtB,MAAM,GAAG,MAAMuB,OAAO,CAACC,GAAG,CAC9BH,WAAW,CAACI,GAAG,CAAEC,UAAU,IAAK;IAC9BC,uBAAc,CAACC,UAAU,CAACF,UAAU,CAACb,EAAE,EAAE;MACvCgB,IAAI,EAAEH,UAAU,CAACI;IACnB,CAAC,CAAC;EACJ,CAAC,CACH,CAAC;EAEDvC,GAAG,CAACwC,IAAI,CAAC/B,MAAM,CAAC;AAClB,CAAC,CAAC;AAEFf,WAAW,CAACE,IAAI,CACd,wCAAwC,EACxC,IAAAC,WAAM,EAAC,CAAC,OAAO,CAAC,CAAC,EACjB,IAAAgB,aAAI,EAAC,CAAC,EACN,IAAAf,wBAAW,EAAC,MAAOC,GAAG,IAAK;EACzB,MAAM;IAAE0C;EAAQ,CAAC,GAAG5E,CAAC,CAACwC,QAAQ,CAAC;IAAEoC,OAAO,EAAE5E,CAAC,CAACyC;EAAO,CAAC,EAAEP,GAAG,CAACS,IAAI,CAAC;EAE/D,MAAM,IAAAkC,sDAAiC,EAACD,OAAO,CAAC;EAEhD,OAAO;IACLE,OAAO,EAAE;EACX,CAAC;AACH,CAAC,CACH,CAAC;AAAC,IAAAC,QAAA,GAAAC,OAAA,CAAApE,OAAA,GAEaiB,WAAW","ignoreList":[]}