{"version":3,"file":"Users.js","names":["_express","require","_verifyHMAC","_SafeRequest","_userController","_interopRequireDefault","_SafeDatabaseTransaction","V","_interopRequireWildcard","_JWT","_Date","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","UserRouter","Router","useHMAC","safeRequest","req","res","confirmed","validate","booleanAsString","optional","query","console","log","totalUsersTransaction","userController","getTotalUsers","Boolean","setHeader","safeReturnTransaction","post","useJWT","userId","string","body","deleteUser","success","phone_number","phone","user","getUserByPhoneNumber","data","transactionError","FAIL_REASONS","NOT_FOUND","id","name","phoneNumber","city","DOB","sex","neighborhood","profession","source","nullable","enums","boolean","userUpsertTransaction","upsertUser","parseDateBR","getTime","eventId","checkInTransaction","userAttendToEvent","_default","exports"],"sources":["../../src/Router/Users.ts"],"sourcesContent":["import { Router } from \"express\";\nimport { useHMAC } from \"../JWT/verifyHMAC\";\nimport { safeRequest } from \"../Util/SafeRequest\";\nimport userController from \"../database/controllers/userController\";\nimport {\n  FAIL_REASONS,\n  isTransactionSuccessful,\n  safeReturnTransaction,\n  transactionError,\n} from \"../Util/SafeDatabaseTransaction\";\nimport * as V from \"../Util/ZodValidation\";\nimport { useJWT } from \"../JWT\";\nimport { json, success } from \"zod\";\nimport type { WithID } from \"../database/schemas\";\nimport { parseDateBR } from \"../Util/Date\";\n\nconst UserRouter = Router();\n\nUserRouter.get(\n  \"/total\",\n  useHMAC,\n  safeRequest(async (req, res) => {\n    \n    const { confirmed } = V.validate(\n      { confirmed: V.booleanAsString.optional() },\n      req.query as Record<string, string>\n    );\n\n    console.log(\"Getting total users, confirmed = \" + confirmed);\n\n    const totalUsersTransaction = await userController.getTotalUsers(\n      Boolean(confirmed)\n    );\n\n    // avoid cacheing the result\n    res.setHeader(\n      \"Cache-Control\",\n      \"no-store, no-cache, must-revalidate, max-age=0, s-maxage=0\"\n    );\n    res.setHeader(\"Pragma\", \"no-cache\");\n    res.setHeader(\"Expires\", \"0\");\n\n    return safeReturnTransaction(totalUsersTransaction);\n  })\n);\n\nUserRouter.post(\n  \"/delete_user\",\n  useJWT([\"admin\"]),\n  safeRequest(async (req, res) => {\n    const { userId } = V.validate({ userId: V.string }, req.body);\n\n    await userController.deleteUser(userId);\n\n    return {\n      success: true,\n    };\n  })\n);\n\nUserRouter.get(\n  \"/info\",\n  useJWT([\"admin\"]),\n  safeRequest(async (req, res) => {\n    const { phone_number } = V.validate(\n      {\n        phone_number: V.phone,\n      },\n      req.query as Record<string, string>\n    );\n\n    const user = await userController.getUserByPhoneNumber(phone_number);\n\n    if (user) {\n      return {\n        success: true,\n        data: user,\n      };\n    } else {\n      safeReturnTransaction(transactionError(FAIL_REASONS.NOT_FOUND));\n    }\n  })\n);\n\nUserRouter.post(\n  \"/upsert\",\n  useJWT([\"admin\"]),\n  safeRequest(async (req, res) => {\n    const {\n      id,\n      name,\n      phoneNumber,\n      city,\n      DOB,\n      sex,\n      neighborhood,\n      profession,\n      source,\n      confirmed,\n    } = V.validate(\n      {\n        id: V.string.optional(),\n        name: V.string,\n        phoneNumber: V.phone,\n        city: V.string,\n        DOB: V.string.optional().nullable(),\n        sex: V.enums([\"m\", \"f\"]).optional().nullable(),\n        neighborhood: V.string.optional().nullable(),\n        profession: V.string.optional().nullable(),\n        source: V.string.optional().nullable(),\n        confirmed: V.boolean.optional().nullable(),\n      },\n      req.body\n    );\n\n    const userUpsertTransaction = await userController.upsertUser({\n      id,\n      name,\n      phoneNumber,\n      city,\n      confirmed: !!confirmed ? confirmed : false,\n      DOB: DOB ? parseDateBR(DOB).getTime() : null,\n      sex: sex ? sex : null,\n      neighborhood: !!neighborhood ? neighborhood : null,\n      profession: !!profession ? profession : null,\n      source: !!source ? (source as WithID<\"user\">[\"source\"]) : \"referral\",\n    });\n\n    return safeReturnTransaction(userUpsertTransaction);\n  })\n);\n\nUserRouter.post(\n  \"/check_in\",\n  useJWT([\"admin\"]),\n  safeRequest(async (req, res) => {\n    const { userId, eventId } = V.validate(\n      {\n        userId: V.string,\n        eventId: V.string,\n      },\n      req.body\n    );\n\n    const checkInTransaction = await userController.userAttendToEvent(\n      userId,\n      eventId\n    );\n\n    return safeReturnTransaction(checkInTransaction);\n  })\n);\n\nexport default UserRouter;\n"],"mappings":"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","ignoreList":[]}