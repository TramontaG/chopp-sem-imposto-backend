{"version":3,"file":"confirmationMessage.js","names":["_","_interopRequireDefault","require","_eventsController","_userController","_cryptoService","_Messages","_mimeTypes","_yaseq","_sleep","_jsxRuntime","e","__esModule","default","sendMessageQueue","createTaskQueue","sendConfirmationMessage","userId","eventId","phoneNumber","name","userController","getUserById","bannerUrl","eventsController","getEventById","sanitizedPhone","replace","contactId","RandomMessage","eventConfirmation1","eventConfirmation2","eventConfirmation3","Math","floor","random","link","eventCofirmationCryptoService","encrypt","action","fileName","split","at","mimeType","mime","lookup","Module","sendMessage","withMedia","jsx","data","transportType","duration","sizeInBytes","stickerTags","sleep","RandomInviteMessage","inviteFriendMessage1","inviteFriendMessage2","inviteFriendMessage3","exports","sendConfirmationMessageToEveryone","allUsers","getAllUsers","event","Promise","all","map","user","awaitExecution","id"],"sources":["../../../src/Kozz-Module/Methods/confirmationMessage.tsx"],"sourcesContent":["import Module from \"..\";\nimport eventsController from \"../../database/controllers/eventsController.\";\nimport userController from \"../../database/controllers/userController\";\nimport { eventCofirmationCryptoService } from \"../../Util/crypto-service\";\nimport {\n  eventConfirmation1,\n  eventConfirmation2,\n  eventConfirmation3,\n  inviteFriendMessage1,\n  inviteFriendMessage2,\n  inviteFriendMessage3,\n} from \"../Messages\";\nimport mime from \"mime-types\";\nimport { createTaskQueue } from \"yaseq\";\nimport { sleep } from \"../../Util/sleep\";\n\nconst sendMessageQueue = createTaskQueue();\n\nexport const sendConfirmationMessage = async (\n  userId: string,\n  eventId: string\n) => {\n  const { phoneNumber, name } = await userController.getUserById(userId);\n  const { bannerUrl } = await eventsController.getEventById(eventId);\n\n  const sanitizedPhone = `55${phoneNumber.replace(/[\\D]/g, \"\")}`;\n  const contactId = `${sanitizedPhone}@s.whatsapp.net`;\n\n  const RandomMessage = [\n    eventConfirmation1,\n    eventConfirmation2,\n    eventConfirmation3,\n  ][Math.floor(Math.random() * 3)];\n\n  const link =\n    \"https://iluminandoaescuridao.com.br/confirm?payload=\" +\n    eventCofirmationCryptoService.encrypt({\n      userId,\n      action: \"confirm\",\n      eventId,\n    });\n\n  if (bannerUrl) {\n    const fileName = bannerUrl?.split(\"/\").at(-1);\n    const mimeType = mime.lookup(fileName || \"\");\n\n    Module.sendMessage.withMedia(\n      contactId,\n      \"iae-baileys\",\n      <RandomMessage link={link} name={name} />,\n      {\n        data: bannerUrl,\n        transportType: \"url\",\n        duration: null,\n        fileName: bannerUrl.split(\"/\").at(-1)!,\n        mimeType: mimeType || \"image/jpeg\",\n        sizeInBytes: 0,\n        stickerTags: [],\n      }\n    );\n  } else {\n    Module.sendMessage(\n      contactId,\n      \"iae-baileys\",\n      <RandomMessage link={link} name={name} />\n    );\n  }\n\n  await sleep(2000 + Math.random() * 300); // between 2 and 5 seconds\n\n  const RandomInviteMessage = [\n    inviteFriendMessage1,\n    inviteFriendMessage2,\n    inviteFriendMessage3,\n  ][Math.floor(Math.random() * 3)];\n\n  Module.sendMessage(contactId, \"iae-baileys\", <RandomInviteMessage />);\n};\n\nexport const sendConfirmationMessageToEveryone = async (eventId: string) => {\n  const allUsers = await userController.getAllUsers();\n  const event = await eventsController.getEventById(eventId);\n\n  return Promise.all(\n    allUsers.map(async (user) => {\n      return sendMessageQueue.awaitExecution(async () => {\n        // unoptimezed, event and user are get multiple times\n        // but the memoization takes care ov avoiding multiple\n        // database transactions\n        await sendConfirmationMessage(user.id, event.id);\n\n        return await sleep(Math.random() * 15 * 1000 + 15000); // between 15 amd 30 seconds\n      });\n    })\n  );\n};\n"],"mappings":"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","ignoreList":[]}