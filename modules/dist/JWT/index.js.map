{"version":3,"file":"index.js","names":["_jsonwebtoken","_interopRequireDefault","require","_fs","_adminsController","_express","_cookieParser","_SafeDatabaseTransaction","e","__esModule","default","ownKeys","r","t","Object","keys","getOwnPropertySymbols","o","filter","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","arguments","length","forEach","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","_toPropertyKey","value","configurable","writable","i","_toPrimitive","Symbol","toPrimitive","call","TypeError","String","Number","privateKEY","process","env","PRIVATE_KEY","fs","readFileSync","publicKEY","PUBLIC_KEY","algorithm","signOptions","verifyOptions","algorithms","generateJwt","credentials","jwt","sign","seed","Math","random","toString","exports","verifyJwt","token","verify","checkJWT","permissions","userId","username","adminDataTransaction","adminsController","getAdmin","isTransactionSuccessful","adminData","data","hasAllPerms","arraysContainAllElements","includes","console","warn","A","B","every","element","useJWT","jwtMiddleware","req","res","next","headers","authorization","body","params","cookies","status","send","errorType","message","jwtResult","context","set","newJwt","cookie","httpOnly","expires","Date","now","sameSite","secure","cookieParser","json"],"sources":["../../src/JWT/index.ts"],"sourcesContent":["import jwt, { type Algorithm } from \"jsonwebtoken\";\nimport fs from \"fs\";\nimport adminsController from \"../database/controllers/adminsController\";\nimport { json, type RequestHandler } from \"express\";\nimport cookieParser from \"cookie-parser\";\nimport {\n  isTransactionSuccessful,\n  safeReturnTransaction,\n} from \"../Util/SafeDatabaseTransaction\";\n\nconst privateKEY =\n  process.env.PRIVATE_KEY ?? fs.readFileSync(\"./keys/privatekey.pem\", \"utf8\");\nconst publicKEY =\n  process.env.PUBLIC_KEY ?? fs.readFileSync(\"./keys/publickey.pem\", \"utf8\");\n\nif (!privateKEY || !publicKEY) {\n  throw 'You need the necessary keys to run this API. Please run the script located at \"./scrips/generate_key_pair.sh\".';\n}\n\nconst algorithm: Algorithm = \"RS512\";\n\nconst signOptions = {\n  algorithm,\n};\n\nconst verifyOptions = {\n  algorithms: [algorithm],\n};\n\ntype JWTCredentials = {\n  userId: string;\n  username: string;\n};\n\nexport const generateJwt = (credentials: JWTCredentials) => {\n  return jwt.sign(\n    {\n      ...credentials,\n      seed: Math.random().toString(),\n    },\n    privateKEY,\n    signOptions\n  );\n};\n\nexport const verifyJwt = (token: string) => {\n  return jwt.verify(token, publicKEY, verifyOptions) as JWTCredentials;\n};\n\nexport const checkJWT = async (jwt: string, permissions: string[]) => {\n  try {\n    const { userId, username } = verifyJwt(jwt);\n\n    const adminDataTransaction = await adminsController.getAdmin(userId);\n    if (!isTransactionSuccessful(adminDataTransaction)) {\n      return false;\n    }\n\n    const adminData = adminDataTransaction.data;\n\n    const hasAllPerms =\n      arraysContainAllElements(adminData.permissions, permissions) ||\n      adminData.permissions.includes(\"*\");\n\n    if (hasAllPerms) {\n      return {\n        userId,\n        username,\n      };\n    } else {\n      return false;\n    }\n  } catch (e) {\n    console.warn(e);\n    return false;\n  }\n};\n\nexport const arraysContainAllElements = <T>(A: T[], B: T[]): boolean => {\n  return B.every((element) => A.includes(element));\n};\n\nexport const useJWT = (permissions: string[] = []): RequestHandler[] => {\n  const jwtMiddleware: RequestHandler = async (req, res, next) => {\n    const jwt: string =\n      req.headers.authorization ||\n      req.body.jwt ||\n      req.params.jwt ||\n      req.cookies.jwt;\n    if (!jwt) {\n      return res.status(401).send({\n        errorType: \"Transaction\",\n        message: \"Please login to continue\",\n      });\n    }\n\n    const jwtResult = await checkJWT(jwt, permissions);\n\n    if (jwtResult) {\n      req.context.set(\"userId\", jwtResult.userId);\n\n      const newJwt = generateJwt(jwtResult);\n\n      res.cookie(\"jwt\", newJwt, {\n        httpOnly: true,\n        expires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),\n        sameSite: \"none\",\n        secure: true,\n      });\n\n      return next();\n    } else {\n      res.status(403).send({\n        errorType: \"Transaction\",\n        message: \"Not authorized\",\n      });\n    }\n  };\n\n  return [cookieParser(), json(), jwtMiddleware];\n};\n"],"mappings":"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","ignoreList":[]}