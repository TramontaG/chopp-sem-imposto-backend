{"version":3,"file":"verifyHMAC.js","names":["_crypto","_interopRequireDefault","require","_express","_","_cookieParser","e","__esModule","default","WEBHOOK_SECRET","process","env","Error","MAX_SKEW_SECONDS","verify","rawBody","ts","header","alg","sigHex","split","now","Math","floor","Date","tsi","parseInt","Number","isFinite","abs","expected","crypto","createHmac","update","digest","timingSafeEqual","Buffer","from","HMACMiddleware","req","res","next","jwt","headers","authorization","body","params","cookies","verified","verifyJwt","chunks","on","c","push","concat","JSON","parse","toString","sig","raw","status","json","error","exports","useHMAC","cookieParser"],"sources":["../../src/JWT/verifyHMAC.ts"],"sourcesContent":["import crypto from \"crypto\";\nimport { json, type RequestHandler } from \"express\";\nimport { useJWT, verifyJwt } from \".\";\nimport cookieParser from \"cookie-parser\";\n\nconst WEBHOOK_SECRET = process.env.WEBHOOK_SECRET;\nif (!WEBHOOK_SECRET) {\n  throw new Error(\"You need a WEBHOOK_SECRET env var\");\n}\n\nconst MAX_SKEW_SECONDS = 300; // 5 min de tolerância\n\nconst verify = (rawBody: string, ts: string, header: string) => {\n  const [alg, sigHex] = (header || \"\").split(\"=\", 2);\n  if (alg !== \"sha256\" || !sigHex) return false;\n\n  // cheque skew do timestamp (ex.: 300s)\n  const now = Math.floor(Date.now() / 1000);\n  const tsi = parseInt(ts, 10);\n  if (!Number.isFinite(tsi) || Math.abs(now - tsi) > MAX_SKEW_SECONDS)\n    return false;\n\n  const expected = crypto\n    .createHmac(\"sha256\", WEBHOOK_SECRET)\n    .update(`${ts}.${rawBody}`)\n    .digest(\"hex\");\n\n  // comparação em tempo constante\n  return crypto.timingSafeEqual(\n    Buffer.from(sigHex, \"hex\"),\n    Buffer.from(expected, \"hex\")\n  );\n};\n\nexport const HMACMiddleware: RequestHandler = (req, res, next) => {\n  const jwt: string =\n    req.headers?.authorization ||\n    (req.body ?? {}).jwt || //req.body is undefined when method is GET\n    req.params?.jwt ||\n    req.cookies?.jwt;\n\n  if (jwt) {\n    const verified = verifyJwt(jwt);\n    if (verified) {\n      return next();\n    }\n  }\n\n  const chunks: Buffer[] = [];\n  req.on(\"data\", (c) => chunks.push(c));\n  req.on(\"end\", () => {\n    (req as any).rawBody = Buffer.concat(chunks);\n    try {\n      req.body = JSON.parse((req as any).rawBody.toString(\"utf8\") || \"{}\");\n    } catch {\n      req.body = null;\n    }\n    const sig = req.header(\"X-Signature\") || \"\";\n    const ts = req.header(\"X-Timestamp\") || \"\";\n\n    const raw = (req as any).rawBody?.toString(\"utf8\") || \"no-body\";\n\n    if (!verify(raw, ts, sig)) {\n      return res.status(401).json({ error: \"Invalid signature or timestamp\" });\n    }\n\n    next();\n  });\n};\n\nexport const useHMAC = [json(), cookieParser(), HMACMiddleware];\n"],"mappings":"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","ignoreList":[]}