{"version":3,"file":"adminsController.js","names":["_","_interopRequireDefault","require","_SafeDatabaseTransaction","_crypto","e","__esModule","default","adminDb","DbManager","queries","getAdminByUsername","username","createQuery","q","where","hashPassword","password","salt","Promise","resolve","reject","crypto","scrypt","err","derivedKey","toString","adminController","createAdmin","name","permissions","adminExists","runQuery","transactionError","FAIL_REASONS","ALREADY_EXISTS","id","randomUUID","randomBytes","admin","passwordHash","createdAt","Date","now","updatedAt","deletedAt","upsertEntity","transactionSuccess","getAdmin","entityExists","NOT_FOUND","readEntity","updateAdmin","updateData","deleteAdmin","deleteEntity","login","hashedPassword","FAIL_LOGIN","_default","exports"],"sources":["../../../src/database/controllers/adminsController.ts"],"sourcesContent":["import DbManager from \"..\";\nimport {\n  FAIL_REASONS,\n  transactionError,\n  transactionSuccess,\n} from \"../../Util/SafeDatabaseTransaction\";\nimport type { AllEntitiesModel, DatabaseFriendlyEntityModel } from \"../schemas\";\nimport crypto from \"crypto\";\n\nconst adminDb = DbManager(\"admin\");\n\nconst queries = {\n  getAdminByUsername: (username: string) =>\n    adminDb.createQuery((q) => q.where(\"username\", \"==\", username)),\n};\n\nconst hashPassword = (password: string, salt: string): Promise<string> => {\n  return new Promise((resolve, reject) => {\n    crypto.scrypt(password, salt, 128, (err, derivedKey) => {\n      if (err) reject(err);\n      resolve(derivedKey.toString(\"hex\"));\n    });\n  });\n};\n\nconst adminController = () => {\n  const createAdmin = async ({\n    username,\n    password,\n    name,\n    permissions,\n  }: {\n    username: string;\n    name: string;\n    permissions: string[];\n    password: string;\n  }) => {\n    const adminExists = (\n      await adminDb.runQuery(queries.getAdminByUsername(username))\n    )[0];\n\n    if (!!adminExists) {\n      return transactionError(FAIL_REASONS.ALREADY_EXISTS);\n    }\n\n    const id = `admin_${name}_${crypto.randomUUID()}`;\n    const salt = crypto.randomBytes(32).toString(\"hex\");\n\n    const admin: AllEntitiesModel[\"admin\"] = {\n      username,\n      name,\n      salt,\n      permissions,\n      passwordHash: await hashPassword(password, salt),\n\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      deletedAt: null,\n    };\n\n    await adminDb.upsertEntity(id, admin);\n\n    return transactionSuccess(id);\n  };\n\n  const getAdmin = async (id: string) => {\n    const adminExists = await adminDb.entityExists(id);\n    if (!adminExists) return transactionError(FAIL_REASONS.NOT_FOUND);\n\n    return transactionSuccess(await adminDb.readEntity(id));\n  };\n\n  const updateAdmin = async (\n    id: string,\n    updateData: Partial<DatabaseFriendlyEntityModel<\"admin\">>\n  ) => {\n    const adminExists = await adminDb.entityExists(id);\n    if (!adminExists) return transactionError(FAIL_REASONS.NOT_FOUND);\n\n    return transactionSuccess(await adminDb.upsertEntity(id, updateData));\n  };\n\n  const deleteAdmin = async (id: string) => {\n    const adminExists = await adminDb.entityExists(id);\n    if (!adminExists) return transactionError(FAIL_REASONS.NOT_FOUND);\n\n    return await adminDb.deleteEntity(id);\n  };\n\n  const login = async (username: string, password: string) => {\n    const admin = (\n      await adminDb.runQuery(queries.getAdminByUsername(username))\n    )[0];\n    if (!admin) return transactionError(FAIL_REASONS.NOT_FOUND);\n\n    const hashedPassword = await hashPassword(password, admin.salt);\n    if (hashedPassword !== admin.passwordHash)\n      return transactionError(FAIL_REASONS.FAIL_LOGIN);\n\n    return transactionSuccess(admin);\n  };\n\n  return {\n    createAdmin,\n    getAdmin,\n    updateAdmin,\n    deleteAdmin,\n    login,\n  };\n};\n\nexport default adminController();\n"],"mappings":"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","ignoreList":[]}