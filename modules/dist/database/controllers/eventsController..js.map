{"version":3,"file":"eventsController..js","names":["_yasms","require","_","_interopRequireDefault","_SafeDatabaseTransaction","_firestore","e","__esModule","default","MINUTE_IN_MS","eventsMemo","createMemoService","undefined","eventsDb","DbManager","queries","upcomingEvents","createQuery","q","where","Date","now","pastEvents","allEvents","todayEvents","startOfDay","setHours","endOfDay","Filter","and","getTime","eventsController","createEvent","name","description","location","organizer","date","bannerUrl","id","crypto","randomUUID","eventData","attendees","comments","hostContatInfo","interested","invited","medias","type","createdAt","updatedAt","deletedAt","transactionSuccess","upsertEntity","updateEvent","data","eventExists","assertEventExists","transactionError","FAIL_REASONS","UPDATE_NON_EXISTENT_ENTITY","getEventById","getData","readEntity","then","val","deleteEvent","deleteData","deleteEntity","entityExists","getUpcomingEvents","runQuery","getPastEvents","getEventsForToday","_default","exports"],"sources":["../../../src/database/controllers/eventsController..ts"],"sourcesContent":["import { createMemoService } from \"yasms\";\nimport DbManager from \"..\";\nimport type {\n  AllEntitiesModel,\n  DatabaseFriendlyEntityModel,\n  WithID,\n} from \"../schemas\";\nimport {\n  FAIL_REASONS,\n  transactionError,\n  transactionSuccess,\n} from \"../../Util/SafeDatabaseTransaction\";\nimport { Filter } from \"firebase-admin/firestore\";\nimport { query } from \"express\";\n\nconst MINUTE_IN_MS = 1000 * 60;\nconst eventsMemo = createMemoService(undefined, MINUTE_IN_MS);\nconst eventsDb = DbManager(\"event\");\n\nconst queries = {\n  upcomingEvents: () =>\n    eventsDb.createQuery((q) => q.where(\"date\", \">\", Date.now())),\n  pastEvents: () =>\n    eventsDb.createQuery((q) => q.where(\"date\", \"<\", Date.now())),\n  allEvents: () =>\n    eventsDb.createQuery((q) => q.where(\"deletedAt\", \"==\", null)),\n  todayEvents: () => {\n    const startOfDay = new Date();\n    startOfDay.setHours(0, 0, 0, 0);\n    const endOfDay = new Date();\n    endOfDay.setHours(23, 59, 59, 999);\n\n    return eventsDb.createQuery((q) =>\n      q.where(\n        Filter.and(\n          Filter.where(\"date\", \">=\", startOfDay.getTime()),\n          Filter.where(\"date\", \"<=\", endOfDay.getTime())\n        )\n      )\n    );\n  },\n};\n\nconst eventsController = () => {\n  const createEvent = async ({\n    name,\n    description,\n    location,\n    organizer,\n    date,\n    bannerUrl,\n  }: {\n    name: string;\n    description: string;\n    location: string;\n    organizer: string | null;\n    date: number;\n    bannerUrl: string | null;\n  }) => {\n    const id = `${name}-${crypto.randomUUID()}`;\n    const eventData: AllEntitiesModel[\"event\"] = {\n      bannerUrl,\n      attendees: [],\n      comments: [],\n      date,\n      description,\n      hostContatInfo: null,\n      interested: [],\n      invited: [],\n      location,\n      medias: [],\n      name,\n      organizer,\n      type: \"other\",\n\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      deletedAt: null,\n    };\n\n    return transactionSuccess(await eventsDb.upsertEntity(id, eventData));\n  };\n\n  const updateEvent = async (\n    id: string,\n    data: Partial<DatabaseFriendlyEntityModel<\"event\">>\n  ) => {\n    const eventExists = await assertEventExists(id);\n    if (!eventExists) {\n      return transactionError(FAIL_REASONS.UPDATE_NON_EXISTENT_ENTITY);\n    }\n\n    return transactionSuccess(await eventsDb.upsertEntity(id, data));\n  };\n\n  const getEventById = (id: string): Promise<WithID<\"event\">> =>\n    eventsMemo\n      .getData(id, () => eventsDb.readEntity(id))\n      .then((val) => val.data);\n\n  const deleteEvent = (id: string) => {\n    eventsMemo.deleteData(id);\n    eventsDb.deleteEntity(id);\n  };\n\n  const assertEventExists = (id: string): Promise<boolean> =>\n    eventsMemo\n      .getData(`exists/${id}`, () => eventsDb.entityExists(id))\n      .then((val) => val.data);\n\n  const getUpcomingEvents = async () => {\n    const upcomingEvents = await eventsDb.runQuery(queries.upcomingEvents());\n    return upcomingEvents;\n  };\n\n  const getPastEvents = async () => {\n    const pastEvents = await eventsDb.runQuery(queries.pastEvents());\n    return pastEvents;\n  };\n\n  const getEventsForToday = async () => {\n    const todayEvents = await eventsDb.runQuery(queries.todayEvents());\n    return todayEvents;\n  };\n\n  return {\n    createEvent,\n    getEventById,\n    updateEvent,\n    deleteEvent,\n    assertEventExists,\n    getUpcomingEvents,\n    getPastEvents,\n    getEventsForToday,\n  };\n};\n\nexport default eventsController();\n"],"mappings":"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","ignoreList":[]}