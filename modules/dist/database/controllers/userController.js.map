{"version":3,"file":"userController.js","names":["_firestore","require","_","_interopRequireDefault","e","__esModule","default","ownKeys","r","t","Object","keys","getOwnPropertySymbols","o","filter","getOwnPropertyDescriptor","enumerable","push","apply","_objectSpread","arguments","length","forEach","_defineProperty","getOwnPropertyDescriptors","defineProperties","defineProperty","_toPropertyKey","value","configurable","writable","i","_toPrimitive","Symbol","toPrimitive","call","TypeError","String","Number","userDB","DbManager","queries","filterByPhoneNumber","phoneNumber","createQuery","q","where","userManager","createUser","name","city","DOB","source","userData","id","crypto","randomUUID","confirmed","eventsAttended","createdAt","Date","now","updatedAt","deletedAt","neighborhood","profession","sex","upsertEntity","updateUser","data","getUserById","readEntity","deleteUser","assertUserExists","exists","entityExists","assertPhoneNotInUse","results","runQuery","userAttendToEvent","userId","eventId","userExists","Error","FieldValue","arrayUnion","_default","exports"],"sources":["../../../src/database/controllers/userController.ts"],"sourcesContent":["import { FieldValue } from \"firebase-admin/firestore\";\nimport DbManager from \"..\";\nimport type { AllEntitiesModel, DatabaseFriendlyEntityModel } from \"../schemas\";\n\nconst userDB = DbManager(\"user\");\n\nconst queries = {\n  filterByPhoneNumber: (phoneNumber: string) => {\n    return userDB.createQuery((q) =>\n      q.where(\"phoneNumber\", \"==\", phoneNumber).where(\"deletedAt\", \"==\", null)\n    );\n  },\n};\n\nconst userManager = () => {\n  const createUser = ({\n    name,\n    phoneNumber,\n    city,\n    DOB,\n    source,\n  }: {\n    name: string;\n    phoneNumber: string;\n    city: string;\n    DOB: string | null;\n    source: AllEntitiesModel[\"user\"][\"source\"] | null;\n  }) => {\n    const userData: AllEntitiesModel[\"user\"] = {\n      id: `${name}-${crypto.randomUUID()}`,\n      name,\n      phoneNumber,\n      city,\n      DOB,\n      confirmed: false,\n      eventsAttended: [],\n      createdAt: Date.now(),\n      updatedAt: Date.now(),\n      deletedAt: null,\n      neighborhood: null,\n      profession: null,\n      sex: null,\n      source: source || \"novo\",\n    };\n\n    return userDB.upsertEntity(userData.id, userData);\n  };\n\n  const updateUser = (\n    id: string,\n    data: Partial<DatabaseFriendlyEntityModel<\"user\">>\n  ) => {\n    return userDB.upsertEntity(id, {\n      ...data,\n      updatedAt: Date.now(),\n    });\n  };\n\n  const getUserById = (id: string) => {\n    return userDB.readEntity(id);\n  };\n\n  const deleteUser = (id: string) => {\n    return userDB.upsertEntity(id, { deletedAt: Date.now() });\n  };\n\n  const assertUserExists = async (id: string) => {\n    const exists = await userDB.entityExists(id);\n    return exists;\n  };\n\n  const assertPhoneNotInUse = async (phoneNumber: string) => {\n    const results = await userDB.runQuery(\n      queries.filterByPhoneNumber(phoneNumber)\n    );\n\n    return results.length === 0;\n  };\n\n  const userAttendToEvent = async (userId: string, eventId: string) => {\n    const userExists = await assertUserExists(userId);\n    if (!userExists) throw new Error(\"User does not exist\");\n\n    updateUser(userId, {\n      eventsAttended: FieldValue.arrayUnion(eventId),\n    });\n  };\n\n  return {\n    createUser,\n    updateUser,\n    getUserById,\n    deleteUser,\n    assertUserExists,\n    assertPhoneNotInUse,\n    userAttendToEvent,\n  };\n};\n\nexport default userManager();\n"],"mappings":"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","ignoreList":[]}